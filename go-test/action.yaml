name: go-test
description: |
  This action tests and lints Go code in a repository.
  It includes unit tests, Go linting, YAML linting, and vulnerability scanning using Trivy.
  The action is designed to be reusable across different workflows.

inputs:
  go-version:
    description: 'Version of Go to use'
    required: false
    default: '1.25.0'
  scan-severity:
    description: 'Trivy scan severity'
    required: false
    default: 'CRITICAL,HIGH'
  linter-version:
    description: 'Version of golangci version to use'
    required: false
    default: v2.4.0
  yaml-linter-config-path:
    description: 'Path to the YAML linter config file'
    required: false
    default: '.yamllint'
  go-linter-config-path:
    description: 'Path to the Go linter config file'
    required: false
    default: '.golangci.yaml'

runs:
  using: "composite"

  steps:

  # Setup Environment
  - name: Checkout Code
    uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0
  - name: Setup Go
    uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5  # v5.5.0
    with:
      go-version: '${{ inputs.go-version }}'
      cache: true
      cache-dependency-path: |
        go.sum
        **/go.sum

  # Unit Tests
  - name: Tidy Modules
    shell: bash
    run: |
      go version
      go mod tidy
  - name: Unit Test
    shell: bash
    run: |
      go test -count=1 -covermode=atomic -coverprofile=coverage.out ./...
      go tool cover -func=coverage.out
  - name: Parse Coverage
    uses: codecov/codecov-action@4fe8c5f003fae66aa5ebb77cfd3e7bfbbda0b6b0  # v3.1.5
    with:
      flags: unittests  # optional

  # Lint Code
  - name: Config Go Lint
    id: golangci_config
    uses: andstor/file-existence-action@076e0072799f4942c8bc574a82233e1e4d13e9d6  # v2.0
    with:
      files: ${{ inputs.go-linter-config-path }}
  - name: Lint Go
    if: steps.golangci_config.outputs.files_exists == 'true'
    uses: golangci/golangci-lint-action@4afd733a84b1f43292c63897423277bb7f4313a9  # v8.0.0
    with:
      version: ${{ inputs.linter-version }}
  - name: Config YAML Lint
    id: yamllint_config
    uses: andstor/file-existence-action@076e0072799f4942c8bc574a82233e1e4d13e9d6  # v2.0
    with:
      files: ${{ inputs.yaml-linter-config-path }}
  - name: Lint YAML
    if: steps.yamllint_config.outputs.files_exists == 'true'
    uses: karancode/yamllint-github-action@fdef6bc189425ecc84cc4543b2674566c0827053  # master
    with:
      yamllint_config_filepath: ${{ inputs.yaml-linter-config-path }}

  # Scan for Vulnerabilities
  - name: Scan Repo
    uses: aquasecurity/trivy-action@dc5a429b52fcf669ce959baa2c2dd26090d2a6c4  # master
    with:
      scan-type: 'fs'
      ignore-unfixed: true
      hide-progress: true
      format: 'sarif'
      output: 'trivy-results.sarif'
      severity: ${{ inputs.scan-severity }}
      exit-code: '1'
  - name: Upload Report
    uses: github/codeql-action/upload-sarif@168b99b3c22180941ae7dbdd5f5c9678ede476ba  # v2.11.6
    with:
      sarif_file: 'trivy-results.sarif'